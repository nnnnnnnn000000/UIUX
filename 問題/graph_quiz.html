<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¸‰è§’é–¢æ•°ã‚¯ã‚¤ã‚º</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      background: #e6ffee;
    }

    .quiz-container {
      background: white;
      padding: 30px;
      max-width: 600px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #2a6ebb;
    }

    ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid #2a6ebb;
      border-radius: 6px;
      background: white;
      color: #2a6ebb;
      cursor: pointer;
    }

    button:hover:not(:disabled) {
      background: #2a6ebb;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #result {
      text-align: center;
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    .correct { color: green; }
    .incorrect { color: red; }

    #next-btn {
      display: none;
      margin: 20px auto 0;
      display: block;
    }
  </style>
</head>
<body>
  <h2>ä¸‰è§’é–¢æ•°ï¼šç¢ºèªå•é¡Œ</h2>
  <div class="quiz-container">
    <p id="question"></p>
    <ul id="choices"></ul>
    <p id="result"></p>
    <button id="next-btn">æ¬¡ã¸ â–¶</button>
  </div>

  <script>
    const originalQuestions = [
      {
        text: "y = sin(x) ã®å‘¨æœŸã¯ï¼Ÿ",
        choices: ["Ï€", "2Ï€", "3Ï€", "4Ï€"],
        correctIndex: 1
      },
      {
        text: "y = cos(x) ã®æœ€å¤§å€¤ã¯ï¼Ÿ",
        choices: ["1", "0", "-1", "2"],
        correctIndex: 0
      },
      {
        text: "y = tan(x) ãŒå®šç¾©ã•ã‚Œãªã„ç‚¹ã¯ï¼Ÿ",
        choices: ["0", "Ï€", "Ï€/2", "2Ï€"],
        correctIndex: 2
      }
    ];

    let questions = [...originalQuestions];
    let current = 0;
    let correct = 0;
    let total = 0;
    let incorrectQuestions = [];
    let retryIncorrectQuestions = [];
    let isRetryMode = false;

    let questionEl = document.getElementById('question');
    let choicesEl = document.getElementById('choices');
    let resultEl = document.getElementById('result');
    let nextBtn = document.getElementById('next-btn');

    function saveProgress(subject, unit, correct, total, isRetryMode) {
      const key = `progress_${subject}_${unit}`;
      const stored = JSON.parse(localStorage.getItem(key) || '{}');
      const rate = total > 0 ? ((correct / total) * 100).toFixed(1) : '0.0';

      // âœ… åˆå›çµæœã¯ã€Œæœªä¿å­˜ã®å ´åˆã®ã¿ä¿å­˜ã€
      if (!stored.firstAttempt && !isRetryMode) {
        stored.firstAttempt = { correct, total, rate };

      }

      // âœ… æœ€çµ‚çµæœã¯æ¯å›æ›´æ–°
      stored.finalAttempt = { correct, total, rate };

      localStorage.setItem(key, JSON.stringify(stored));
    }

    nextBtn.addEventListener('click', next);

    function render() {
      const q = questions[current];
      questionEl.textContent = `å•é¡Œ${current + 1}ï¼š${q.text}`;
      resultEl.textContent = '';
      resultEl.className = '';
      nextBtn.style.display = 'none';
      choicesEl.innerHTML = '';

      q.choices.forEach((choice, i) => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.textContent = choice;
        btn.onclick = () => check(i === q.correctIndex);
        li.appendChild(btn);
        choicesEl.appendChild(li);
      });
    }

    function check(isCorrect) {
      total++;
      const q = questions[current];

      if (!isCorrect) {
        const target = isRetryMode ? retryIncorrectQuestions : incorrectQuestions;
        if (!target.includes(q)) target.push(q);
      }

      if (isCorrect) {
        correct++;
        resultEl.textContent = 'æ­£è§£ï¼';
        resultEl.className = 'correct';
      } else {
        resultEl.textContent = 'ä¸æ­£è§£â€¦';
        resultEl.className = 'incorrect';
      }

      document.querySelectorAll('#choices button').forEach(btn => btn.disabled = true);
      nextBtn.style.display = 'block';
    }

    function next() {
      current++;
      if (current < questions.length) {
        render();
      } else {
        finish();
      }
    }

    function finish() {
      const rate = ((correct / total) * 100).toFixed(1);
      const container = document.querySelector('.quiz-container');
      container.innerHTML = `
        <p style="text-align:center; font-weight:bold; font-size:20px; color:#2a6ebb">
          å…¨ã¦ã®å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸï¼
        </p>
        <div style="text-align:center; font-size:18px;">
          <p>æ­£è§£æ•°ï¼š${correct} / ${total}</p>
          <p>æ­£ç­”ç‡ï¼š${rate}%</p>
        </div>
        <div style="text-align:center; margin-top:20px;">
          <button id="retry">é–“é•ãˆãŸå•é¡Œã ã‘å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
          <button id="go-explanation" style="margin-left: 10px;">ã“ã®å˜å…ƒã®è§£èª¬ã‚’è¦‹ã‚‹</button>
          <button id="go-progress" style="margin-left: 10px;">é€²æ—çŠ¶æ³ã‚’è¦‹ã‚‹</button>
        </div>
      `;

      saveProgress("åŸºç¤æ•°å­¦", "ã‚°ãƒ©ãƒ•ã¨ä¸‰è§’é–¢æ•°", correct, total, isRetryMode);

      // å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³
      document.getElementById('retry').addEventListener('click', () => {
        const retrySource = isRetryMode ? retryIncorrectQuestions : incorrectQuestions;
        if (retrySource.length === 0) {
          alert('å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ï¼');
          return;
        }

        questions = [...retrySource];
        if (isRetryMode) {
          retryIncorrectQuestions = [];
        } else {
          incorrectQuestions = [];
        }
        

    isRetryMode = true;
    current = 0;
    correct = 0;
    total = 0;

    // HTMLã‚’å…ƒã«æˆ»ã™
    document.querySelector('.quiz-container').innerHTML = `
      <p id="question"></p>
      <ul id="choices"></ul>
      <p id="result"></p>
      <button id="next-btn">æ¬¡ã¸ â–¶</button>
    `;

    // è¦ç´ ã‚’å†å–å¾—
    questionEl = document.getElementById('question');
    choicesEl = document.getElementById('choices');
    resultEl = document.getElementById('result');
    nextBtn = document.getElementById('next-btn');

    // ã‚¤ãƒ™ãƒ³ãƒˆå†ç™»éŒ²
    nextBtn.addEventListener('click', next);

    render();
  });

  // ğŸ”½ è§£èª¬ãƒœã‚¿ãƒ³ï¼ˆã“ã‚ŒãŒè¿½åŠ éƒ¨åˆ†ï¼ï¼‰
  document.getElementById('go-explanation').addEventListener('click', () => {
    window.location.href = '../è§£èª¬/graph.html';
  });
  
   // ğŸ”½ é€²æ—ãƒœã‚¿ãƒ³ï¼ˆæ–°ã—ãè¿½åŠ ï¼‰
  document.getElementById('go-progress').addEventListener('click', () => {
    window.location.href = '../progress.html';  // â†å¿…è¦ã«å¿œã˜ã¦ãƒ‘ã‚¹ã‚’èª¿æ•´
  });

}


    render();
  </script>
</body>
</html>