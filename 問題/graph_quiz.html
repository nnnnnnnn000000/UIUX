<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>三角関数クイズ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      background: #e6ffee;
    }

    .quiz-container {
      background: white;
      padding: 30px;
      max-width: 600px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #2a6ebb;
    }

    ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid #2a6ebb;
      border-radius: 6px;
      background: white;
      color: #2a6ebb;
      cursor: pointer;
    }

    button:hover:not(:disabled) {
      background: #2a6ebb;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #result {
      text-align: center;
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    .correct { color: green; }
    .incorrect { color: red; }

    #next-btn {
      display: none;
      margin: 20px auto 0;
      display: block;
    }
  </style>
</head>
<body>
  <h2>三角関数：確認問題</h2>
  <div class="quiz-container">
    <p id="question"></p>
    <ul id="choices"></ul>
    <p id="result"></p>
    <button id="next-btn">次へ ▶</button>
  </div>

  <script>
    const originalQuestions = [
      {
        text: "y = sin(x) の周期は？",
        choices: ["π", "2π", "3π", "4π"],
        correctIndex: 1
      },
      {
        text: "y = cos(x) の最大値は？",
        choices: ["1", "0", "-1", "2"],
        correctIndex: 0
      },
      {
        text: "y = tan(x) が定義されない点は？",
        choices: ["0", "π", "π/2", "2π"],
        correctIndex: 2
      }
    ];

    let questions = [...originalQuestions];
    let current = 0;
    let correct = 0;
    let total = 0;
    let incorrectQuestions = [];
    let retryIncorrectQuestions = [];
    let isRetryMode = false;

    let questionEl = document.getElementById('question');
    let choicesEl = document.getElementById('choices');
    let resultEl = document.getElementById('result');
    let nextBtn = document.getElementById('next-btn');

    nextBtn.addEventListener('click', next);

    function render() {
      const q = questions[current];
      questionEl.textContent = `問題${current + 1}：${q.text}`;
      resultEl.textContent = '';
      resultEl.className = '';
      nextBtn.style.display = 'none';
      choicesEl.innerHTML = '';

      q.choices.forEach((choice, i) => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.textContent = choice;
        btn.onclick = () => check(i === q.correctIndex);
        li.appendChild(btn);
        choicesEl.appendChild(li);
      });
    }

    function check(isCorrect) {
      total++;
      const q = questions[current];

      if (!isCorrect) {
        const target = isRetryMode ? retryIncorrectQuestions : incorrectQuestions;
        if (!target.includes(q)) target.push(q);
      }

      if (isCorrect) {
        correct++;
        resultEl.textContent = '正解！';
        resultEl.className = 'correct';
      } else {
        resultEl.textContent = '不正解…';
        resultEl.className = 'incorrect';
      }

      document.querySelectorAll('#choices button').forEach(btn => btn.disabled = true);
      nextBtn.style.display = 'block';
    }

    function next() {
      current++;
      if (current < questions.length) {
        render();
      } else {
        finish();
      }
    }

    function finish() {
      const rate = ((correct / total) * 100).toFixed(1);
      const container = document.querySelector('.quiz-container');
      container.innerHTML = `
        <p style="text-align:center; font-weight:bold; font-size:20px; color:#2a6ebb">
          全ての問題が終了しました！
        </p>
        <div style="text-align:center; font-size:18px;">
          <p>正解数：${correct} / ${total}</p>
          <p>正答率：${rate}%</p>
        </div>
        <div style="text-align:center; margin-top:20px;">
          <button id="retry">間違えた問題だけ再チャレンジ</button>
        </div>
      `;

      document.getElementById('retry').addEventListener('click', () => {
        const retrySource = isRetryMode ? retryIncorrectQuestions : incorrectQuestions;
        if (retrySource.length === 0) {
          alert('再チャレンジする問題はありません！');
          return;
        }

        questions = [...retrySource];
        if (isRetryMode) {
          retryIncorrectQuestions = [];
        } else {
          incorrectQuestions = [];
        }

        isRetryMode = true;
        current = 0;
        correct = 0;
        total = 0;

        // HTMLを元に戻す
        document.querySelector('.quiz-container').innerHTML = `
          <p id="question"></p>
          <ul id="choices"></ul>
          <p id="result"></p>
          <button id="next-btn">次へ ▶</button>
        `;

        // 要素を再取得
        questionEl = document.getElementById('question');
        choicesEl = document.getElementById('choices');
        resultEl = document.getElementById('result');
        nextBtn = document.getElementById('next-btn');

        // イベント再登録
        nextBtn.addEventListener('click', next);

        render();
      });
    }

    render();
  </script>
</body>
</html>